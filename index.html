<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ábaco Ternário Balanceado</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicons/favicon-16x16.png">
    <link rel="manifest" href="assets/favicons/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <!-- Primary Meta Tags -->
    <meta name="title" content="Ábaco Ternário Balanceado | Heisenban">
    <meta name="description" content="Ábaco Ternário Balanceado interativo. Clique nas contas para somar (+1) ou subtrair (-1) e veja a notação matemática renderizada com LaTeX.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Ábaco Ternário Balanceado | Heisenban">
    <meta property="og:locale" content="pt_BR">
    <meta property="og:title" content="Ábaco Ternário Balanceado | Heisenban">
    <meta property="og:description" content="Ábaco Ternário Balanceado interativo. Clique nas contas para somar (+1) ou subtrair (-1) e veja a notação matemática renderizada com LaTeX.">
    <meta property="og:image" content="https://raw.githubusercontent.com/RandintN/abaco-ternario-balanceado/refs/heads/main/assets/triquetra.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:alt" content="Símbolo Triquetra">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Ábaco Ternário Balanceado | Heisenban">
    <meta name="twitter:description" content="Ábaco Ternário Balanceado interativo. Clique nas contas para somar (+1) ou subtrair (-1) e veja a notação matemática renderizada com LaTeX.">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/RandintN/abaco-ternario-balanceado/refs/heads/main/assets/triquetra.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            /* Responsive sizing variables */
            --rod-height: clamp(140px, 28vh, 220px);
            --rod-width: clamp(32px, 8vw, 56px);
            --bead: clamp(16px, 3.8vw, 26px);
            /* Distance a bead travels to touch the center bar: half rod height minus bead height */
            --bead-shift: calc(var(--rod-height) / 2 - var(--bead));
            --center-bar: clamp(2px, 0.5vh, 4px);
            --label-gap: clamp(2.5rem, 6vh, 5.5rem);
            --abacus-padding: clamp(0.5rem, 2.5vw, 1rem);
            --container-padding: clamp(1rem, 4vw, 2rem);
            --rod-margin-x: clamp(0.25rem, 1.5vw, 1rem);
            /* Size of the triad separator dot on the center bar */
            --group-dot: clamp(6px, 1.5vw, 10px);
            /* Vertical offset for power labels (top and bottom) */
            --power-label-offset: clamp(4rem, 5vh, 5.5rem);
            /* Minimum height reserved for the math notation line (prevents layout shift) */
            --notation-minh: clamp(1.8rem, 3.5vh, 2.6rem);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #2d3748;
            border-radius: 1rem;
            padding: var(--container-padding);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 600px;
            position: relative;
        }

        .abacus {
            display: flex;
            align-items: flex-end;
            /* Reserve vertical space above for top decimal labels so they don't overlap the description */
            margin-top: var(--power-label-offset);
            margin-bottom: 2rem;
            position: relative;
            background-color: #4a5568;
            /* Soroban-inspired heaven/earth subtle cue */
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.04) 0 50%, rgba(0,0,0,0.08) 50% 100%);
            border: 4px solid #718096;
            border-radius: 0.5rem;
            padding: var(--abacus-padding);
        }

        .center-bar {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: var(--center-bar);
            background-color: #e2e8f0;
            transform: translateY(-50%);
        }

        .rod {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: var(--rod-height);
            width: var(--rod-width);
            position: relative;
            margin: 0 var(--rod-margin-x);
        }

        .rod-line {
            position: absolute;
            height: 100%;
            width: clamp(1px, 0.3vw, 2px);
            background-color: #a0aec0;
            left: 50%;
            transform: translateX(-50%);
        }

        .bead {
            width: 0;
            height: 0;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            transition: transform 0.3s ease-in-out;
        }

        .bead.top {
            top: 0;
            border-left: var(--bead) solid transparent;
            border-right: var(--bead) solid transparent;
            border-top: var(--bead) solid #48bb78;
        }

        .bead.bottom {
            bottom: 0;
            border-left: var(--bead) solid transparent;
            border-right: var(--bead) solid transparent;
            border-bottom: var(--bead) solid #48bb78;
        }

        .bead.top.active {
            transform: translate(-50%, var(--bead-shift));
            border-top-color: #38a169;
        }

        .bead.bottom.active {
            transform: translate(-50%, calc(-1 * var(--bead-shift)));
            border-bottom-color: #c53030;
        }

        .power-label {
            position: absolute;
            bottom: calc(-1 * var(--power-label-offset));
            font-size: 0.875rem;
            color: #a0aec0;
            text-align: center;
            width: 100%;
        }

        .power-label-top {
            position: absolute;
            top: calc(-1 * var(--power-label-offset));
            font-size: 0.875rem;
            color: #a0aec0;
            text-align: center;
            width: 100%;
        }

        .abacus-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1rem;
            text-align: center;
        }

        /* Reserve space for MathJax notation to avoid flicker/reflow when it appears */
        #math-notation {
            min-height: var(--notation-minh);
            line-height: 1.4;
        }

        .value-labels {
            position: absolute;
            right: -2rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: var(--label-gap);
        }

        .value-labels span {
            font-size: clamp(0.9rem, 2.8vw, 1.25rem);
            font-weight: bold;
            color: #e2e8f0;
        }

        /* Soroban-inspired grouping every 3 rods for readability:
           Replace vertical line with a centered black dot on the center bar */
        #abacus-rods-container .rod:nth-child(3n+1) {
            /* keep a little spacing for readability */
            padding-left: clamp(0.25rem, 1.2vw, 0.5rem);
        }
        #abacus-rods-container .rod:nth-child(3n+1)::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: var(--group-dot);
            height: var(--group-dot);
            background: rgb(0,92,220);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            pointer-events: none;
        }

        .translation-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: #4a5568;
            color: #e2e8f0;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .translation-button:hover {
            background-color: #6a768c;
        }

        .triquetra-logo {
            width: clamp(120px, 25vw, 200px);
            height: auto;
            margin-bottom: 5rem;
            max-width: 100%;
        }

        /* Reserve space on the right so the centered title doesn't sit under the EN button */
        #main-title {
            padding-right: clamp(3rem, 12vw, 6rem);
        }
        /* Fixed GitHub link at top-right of the page */
        .github-link {
            position: fixed;
            top: 0.75rem;
            right: 0.75rem;
            color: #e2e8f0;
            opacity: 0.9;
            z-index: 1000;
            transition: color 0.2s ease, opacity 0.2s ease;
        }
        .github-link:hover {
            color: #63b3ed;
            opacity: 1;
        }
        .github-link svg {
            width: clamp(22px, 3.5vw, 28px);
            height: clamp(22px, 3.5vw, 28px);
            display: block;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col justify-center items-center min-h-screen">
<a href="https://github.com/RandintN/abaco-ternario-balanceado" class="github-link" target="_blank" rel="noopener" aria-label="GitHub repository">
    <svg viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8Z"/>
    </svg>
</a>
<img src="assets/triquetra.png" alt="Símbolo Triquetra" class="triquetra-logo">
<div class="container mx-auto p-8 bg-gray-800 rounded-2xl shadow-lg">
    <button id="translation-button" class="translation-button">EN</button>
    <h1 id="main-title" class="text-3xl font-bold mb-6 text-center text-teal-300">Ábaco Ternário Balanceado</h1>
    <p id="description" class="text-center text-gray-400 mb-8">Clique nas contas para somar (+1) ou subtrair (-1) e ver a representação matemática.</p>

    <div class="abacus flex justify-center p-4 rounded-xl relative">
        <div class="center-bar"></div>
        <div class="abacus-rods flex" id="abacus-rods-container">
            <!-- Rods will be dynamically generated by JavaScript -->
        </div>
        <div class="value-labels">
            <span style="transform: translateY(-1rem);">1</span>
            <span>0</span>
            <span style="transform: translateY(1.2rem);">-1</span>
        </div>
    </div>

    <div class="mt-8 text-center">
        <div class="flex items-center justify-center gap-3 mb-2">
            <h2 id="total-title" class="text-xl font-semibold text-teal-300">Valor Total</h2>
            <button id="clear-button" class="text-xs px-2 py-1 rounded-md bg-gray-600 hover:bg-gray-500 text-gray-100 border border-gray-500">Limpar</button>
        </div>
        <div id="total-value" class="abacus-value text-4xl">0</div>
        <div id="math-notation" class="text-gray-400 mt-4 text-sm font-mono min-h-[1.25rem]"></div>
    </div>

    <div class="mt-8 flex flex-wrap items-center justify-center gap-6 text-center text-sm text-gray-400">
        <button id="tutorial-toggle" class="text-teal-300 hover:text-teal-400 transition-colors">👉 Tutorial de como usar o ábaco</button>
        <button id="sum-toggle" class="text-teal-300 hover:text-teal-400 transition-colors">➕ Como somar</button>
        <button id="sub-toggle" class="text-teal-300 hover:text-teal-400 transition-colors">➖ Como subtrair</button>
        <button id="soroban-toggle" class="text-teal-300 hover:text-teal-400 transition-colors">💡 Dicas do Heisanban</button>
    </div>

    <div id="tutorial-content" class="hidden mt-8 p-6 bg-gray-700 rounded-lg">
        <h2 id="tutorial-title" class="text-2xl font-semibold mb-4 text-white">Tutorial do Ábaco de Lógica Ternária Balanceada</h2>
        <p id="tutorial-p1" class="text-gray-300 mb-4">Este guia rápido explica como usar o ábaco interativo de lógica ternária balanceada, que utiliza os valores <b>1</b> (positivo), <b>0</b> (neutro) e <b>-1</b> (negativo) para representar números.</p>
        <p id="tutorial-p2" class="text-gray-300 mb-4">O ábaco é composto por várias hastes, onde cada uma representa uma potência de 3. As hastes são organizadas da direita para a esquerda, começando com \(3^0\).</p>
        <ul class="list-disc list-inside text-gray-300 space-y-2 mb-4">
            <li id="tutorial-li1"><strong class="text-teal-300">Primeira haste (da direita):</strong> \(3^0\) (valor 1)</li>
            <li id="tutorial-li2"><strong class="text-teal-300">Segunda haste:</strong> \(3^1\) (valor 3)</li>
            <li id="tutorial-li3"><strong class="text-teal-300">Terceira haste:</strong> \(3^2\) (valor 9)</li>
            <li id="tutorial-li4">e assim por diante...</li>
        </ul>

        <h3 id="tutorial-h3-1" class="text-xl font-semibold text-white mb-2">Representando Valores com as Contas</h3>
        <p id="tutorial-p3" class="text-gray-300 mb-4">Cada haste tem duas contas: uma na parte superior e outra na inferior. A barra horizontal central é a referência.</p>
        <ul class="list-disc list-inside text-gray-300 space-y-2 mb-4">
            <li id="tutorial-li5">Para representar o valor <b>1</b> (positivo): Clique na conta superior para que ela encoste na barra central.</li>
            <li id="tutorial-li6">Para representar o valor <b>-1</b> (negativo): Clique na conta inferior para que ela encoste na barra central.</li>
            <li id="tutorial-li7">Para representar o valor <b>0</b> (neutro): Deixe as contas distantes da barra central.</li>
            <li id="tutorial-li8">Uma característica especial do seu ábaco é que você pode representar o <b>0</b> de duas maneiras:</li>
        </ul>
        <ol class="list-decimal list-inside text-gray-300 space-y-2 mb-4">
            <li id="tutorial-li9"><strong class="text-teal-300">Forma "vazia":</strong> Nenhuma conta toca a barra central.</li>
            <li id="tutorial-li10"><strong class="text-teal-300">Forma "balanceada":</strong> Ambas as contas (a superior e a inferior) tocam a barra, já que a soma de \(1 + (-1)\) resulta em \(0\).</li>
        </ol>

        <h3 id="tutorial-h3-2" class="text-xl font-semibold text-white mb-2">Lendo o Valor Total</h3>
        <p id="tutorial-p4" class="text-gray-300 mb-4">O valor total do ábaco é a soma dos valores de cada haste. A aplicação calcula e exibe automaticamente o valor na base 10 (decimal). A notação matemática, como \(1 \cdot 3^1 + (-1) \cdot 3^0\), também é mostrada para ajudar a visualizar o cálculo.</p>
    </div>
</div>

<div id="sum-content" class="hidden mt-6 p-6 bg-gray-700 rounded-lg">
    <h2 id="footer-sum-title" class="text-xl font-semibold text-teal-300 mb-3">Como somar no ábaco</h2>
    <p id="footer-sum-p1" class="mb-3">Para somar dois números, você pode usar o ábaco como uma calculadora manual: primeiro represente o primeiro número; depois aplique o segundo número haste a haste.</p>
    <ol class="list-decimal list-inside space-y-2">
        <li id="footer-sum-li1"><strong class="text-teal-300">1) Configure o primeiro número:</strong> Clique nas contas para formar o valor desejado. O total em decimal aparece acima.</li>
        <li id="footer-sum-li2"><strong class="text-teal-300">2) Adicione o segundo número:</strong> Comece pela haste da direita (\(3^0\)). Para cada unidade a somar, ative a conta de cima (\(+1\)); para cada unidade a subtrair, ative a de baixo (\(-1\)).</li>
        <li id="footer-sum-li3"><strong class="text-teal-300">3) Ajuste os "vai-um" balanceados:</strong> Se uma haste ficar com duas contas ativas do mesmo lado (equivalente a \(+2\) ou \(-2\)), troque por um dígito balanceado e carregue para a próxima haste: \(+2 = -1 + 1\cdot 3\) e \(-2 = 1 - 1\cdot 3\).</li>
    </ol>

    <h3 id="footer-sum-table-title" class="text-lg font-semibold text-white mt-5 mb-2">Tabela de combinações para somar</h3>
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-gray-200">
            <thead>
                <tr class="text-teal-300 border-b border-gray-600">
                    <th id="footer-sum-col1" class="text-left py-2 pr-4">Alvo (+n)</th>
                    <th id="footer-sum-col2" class="text-left py-2">Combinação em potências de 3</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                <tr><td class="py-1 pr-4">+1</td><td class="py-1">\(+1\)</td></tr>
                <tr><td class="py-1 pr-4">+2</td><td class="py-1">\(+3 - 1\)</td></tr>
                <tr><td class="py-1 pr-4">+3</td><td class="py-1">\(+3\)</td></tr>
                <tr><td class="py-1 pr-4">+4</td><td class="py-1">\(+3 + 1\)</td></tr>
                <tr><td class="py-1 pr-4">+5</td><td class="py-1">\(+9 - 3 - 1\)</td></tr>
                <tr><td class="py-1 pr-4">+6</td><td class="py-1">\(+9 - 3\)</td></tr>
                <tr><td class="py-1 pr-4">+7</td><td class="py-1">\(+9 - 3 + 1\)</td></tr>
                <tr><td class="py-1 pr-4">+8</td><td class="py-1">\(+9 - 1\)</td></tr>
                <tr><td class="py-1 pr-4">+9</td><td class="py-1">\(+9\)</td></tr>
            </tbody>
        </table>
    </div>

    <p id="footer-sum-note" class="mt-3 text-gray-400 text-sm">Dica: quando ambas as contas tocam a barra na mesma haste, o valor local é \(0\) — isso ajuda a enxergar combinações como \(1 + (-1) = 0\). Você pode conferir o resultado na leitura em decimal e na notação matemática.</p>
</div>

<div id="sub-content" class="hidden mt-6 p-6 bg-gray-700 rounded-lg">
    <h2 id="footer-sub-title" class="text-xl font-semibold text-teal-300 mb-3">Como subtrair no ábaco</h2>
    <p id="footer-sub-p1" class="mb-3">Para subtrair \(B\) de \(A\), você pode pensar como soma com o oposto: some \(-B\). Outra forma é aplicar as unidades a subtrair haste a haste.</p>
    <ol class="list-decimal list-inside space-y-2">
        <li id="footer-sub-li1"><strong class="text-teal-300">1) Configure o minuendo \(A\):</strong> Represente \(A\) no ábaco. O total em decimal aparece acima.</li>
        <li id="footer-sub-li2"><strong class="text-teal-300">2) Subtraia o subtraendo \(B\):</strong> Comece pela haste da direita (\(3^0\)). Para cada unidade a subtrair, ative a conta de baixo (\(-1\)); para desfazer uma unidade, ative a de cima (\(+1\)).</li>
        <li id="footer-sub-li3"><strong class="text-teal-300">3) Ajuste os "empresta" balanceados:</strong> Se uma haste chegar a \(-2\) ou \(+2\), converta usando os dígitos balanceados e faça o empréstimo/transporte:
            \(-2 = 1 - 1\cdot 3\) (empresta \(1\) para a próxima haste) e \(+2 = -1 + 1\cdot 3\) (carrega \(1\) para a próxima haste).</li>
    </ol>

    <h3 id="footer-sub-table-title" class="text-lg font-semibold text-white mt-5 mb-2">Tabela de combinações para subtrair</h3>
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-gray-200">
            <thead>
                <tr class="text-teal-300 border-b border-gray-600">
                    <th id="footer-sub-col1" class="text-left py-2 pr-4">Alvo (-n)</th>
                    <th id="footer-sub-col2" class="text-left py-2">Combinação em potências de 3</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                <tr><td class="py-1 pr-4">-1</td><td class="py-1">\(-1\)</td></tr>
                <tr><td class="py-1 pr-4">-2</td><td class="py-1">\(-3 + 1\)</td></tr>
                <tr><td class="py-1 pr-4">-3</td><td class="py-1">\(-3\)</td></tr>
                <tr><td class="py-1 pr-4">-4</td><td class="py-1">\(-3 - 1\)</td></tr>
                <tr><td class="py-1 pr-4">-5</td><td class="py-1">\(-9 + 3 + 1\)</td></tr>
                <tr><td class="py-1 pr-4">-6</td><td class="py-1">\(-9 + 3\)</td></tr>
                <tr><td class="py-1 pr-4">-7</td><td class="py-1">\(-9 + 3 - 1\)</td></tr>
                <tr><td class="py-1 pr-4">-8</td><td class="py-1">\(-9 + 1\)</td></tr>
                <tr><td class="py-1 pr-4">-9</td><td class="py-1">\(-9\)</td></tr>
            </tbody>
        </table>
    </div>

    <p id="footer-sub-note" class="mt-3 text-gray-400 text-sm">Dica: subtrair é o mesmo que somar o negativo. Para formar \(-B\), inverta os sinais dos dígitos de \(B\) (\(1 \leftrightarrow -1\)) e então some.</p>
</div>

<div id="soroban-content" class="hidden mt-6 p-6 bg-gray-700 rounded-lg">
    <h2 id="soroban-title" class="text-xl font-semibold text-teal-300 mb-3">Dicas inspiradas no Soroban (ábaco japonês)</h2>
    <p id="soroban-p1" class="mb-3">O Soroban traz práticas úteis de ergonomia e leitura que também servem para este Ábaco Ternário Balanceado.</p>
    <ul class="list-disc list-inside space-y-2">
        <li id="soroban-li1"><strong class="text-teal-300">Agrupamento visual:</strong> As hastes são separadas em grupos de 3 para facilitar a leitura de potências de 3.</li>
        <li id="soroban-li2"><strong class="text-teal-300">Céu e Terra:</strong> A área superior e a inferior têm um leve contraste, lembrando as regiões do Soroban e ajudando na referência visual.</li>
        <li id="soroban-li3"><strong class="text-teal-300">Botão de limpeza:</strong> Use o botão “Limpar” para zerar rapidamente o ábaco, como um movimento de varredura no Soroban.</li>
        <li id="soroban-li4"><strong class="text-teal-300">Leitura da direita para a esquerda:</strong> Comece sempre pela haste de \(3^0\) (direita) ao somar/subtrair, tal como se procede no Soroban.</li>
        <li id="soroban-li5"><strong class="text-teal-300">Fluxo de transporte/empresta:</strong> Ao atingir \(+2\) ou \(-2\) numa haste, converta para um dígito balanceado e transporte/empreste para a próxima haste.</li>
    </ul>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const numRods = 7;
        const abacusRodsContainer = document.getElementById('abacus-rods-container');
        const totalValueDisplay = document.getElementById('total-value');
        const mathNotationDisplay = document.getElementById('math-notation');
        const rodValues = Array(numRods).fill(0);
        const tutorialToggleBtn = document.getElementById('tutorial-toggle');
        const tutorialContentDiv = document.getElementById('tutorial-content');
        const sumToggleBtn = document.getElementById('sum-toggle');
        const sumContentDiv = document.getElementById('sum-content');
        const subToggleBtn = document.getElementById('sub-toggle');
        const subContentDiv = document.getElementById('sub-content');
        const sorobanToggleBtn = document.getElementById('soroban-toggle');
        const sorobanContentDiv = document.getElementById('soroban-content');
        const clearButton = document.getElementById('clear-button');
        const translationBtn = document.getElementById('translation-button');

        // Constants for bead colors (keep exact colors to preserve behavior)
        const COLOR_DEFAULT = '#48bb78';
        const COLOR_TOP_ACTIVE = 'rgb(0, 0, 255)';
        const COLOR_BOTTOM_ACTIVE = 'rgb(197, 48, 48)';
        const COLOR_BOTH_ACTIVE = 'white';

        // Precompute powers of 3 to avoid repeated Math.pow in updates
        const POW3 = Array.from({ length: numRods }, (_, i) => 3 ** i);

        // Helper to apply the visual/logic state of a rod after a click
        const applyRodState = (i, topBead, bottomBead) => {
            const isTopActive = topBead.classList.contains('active');
            const isBottomActive = bottomBead.classList.contains('active');

            if (isTopActive && isBottomActive) {
                topBead.style.borderTopColor = COLOR_BOTH_ACTIVE;
                bottomBead.style.borderBottomColor = COLOR_BOTH_ACTIVE;
                rodValues[i] = 0;
            } else if (isTopActive) {
                topBead.style.borderTopColor = COLOR_TOP_ACTIVE;
                bottomBead.style.borderBottomColor = COLOR_DEFAULT;
                rodValues[i] = 1;
            } else if (isBottomActive) {
                bottomBead.style.borderBottomColor = COLOR_BOTTOM_ACTIVE;
                topBead.style.borderTopColor = COLOR_DEFAULT;
                rodValues[i] = -1;
            } else {
                topBead.style.borderTopColor = COLOR_DEFAULT;
                bottomBead.style.borderBottomColor = COLOR_DEFAULT;
                rodValues[i] = 0;
            }
        };

        // Utility to wire a simple show/hide toggle and typeset MathJax when shown
        const wireToggle = (btn, content) => {
            btn.addEventListener('click', () => {
                content.classList.toggle('hidden');
                if (!content.classList.contains('hidden') && window.MathJax) {
                    window.MathJax.typesetPromise();
                }
            });
        };

        const translations = {
            'pt': {
                'main-title': 'Ábaco Ternário Balanceado',
                'description': 'Clique nas contas para somar (+1) ou subtrair (-1) e ver a representação matemática.',
                'total-title': 'Valor Total',
                'tutorial-toggle': '👉 Tutorial de como usar o ábaco',
                'sum-toggle': '➕ Como somar',
                                'sub-toggle': '➖ Como subtrair',
                'tutorial-title': 'Tutorial do Ábaco de Lógica Ternária Balanceada',
                'tutorial-p1': 'Este guia rápido explica como usar o ábaco interativo de lógica ternária balanceada, que utiliza os valores <b>1</b> (positivo), <b>0</b> (neutro) e <b>-1</b> (negativo) para representar números.',
                'tutorial-p2': 'O ábaco é composto por várias hastes, onde cada uma representa uma potência de 3. As hastes são organizadas da direita para a esquerda, começando com \\(3^0\\).',
                'tutorial-li1': '<strong class="text-teal-300">Primeira haste (da direita):</strong> \\(3^0\\) (valor 1)',
                'tutorial-li2': '<strong class=\"text-teal-300\">Segunda haste:</strong> \\(3^1\\) (valor 3)',
                'tutorial-li3': '<strong class=\"text-teal-300\">Terceira haste:</strong> \\(3^2\\) (valor 9)',
                'tutorial-li4': 'e assim por diante...',
                'tutorial-h3-1': 'Representando Valores com as Contas',
                'tutorial-p3': 'Cada haste tem duas contas: uma na parte superior e outra na inferior. A barra horizontal central é a referência.',
                'tutorial-li5': 'Para representar o valor <b>1</b> (positivo): Clique na conta superior para que ela encoste na barra central.',
                'tutorial-li6': 'Para representar o valor <b>-1</b> (negativo): Clique na conta inferior para que ela encoste na barra central.',
                'tutorial-li7': 'Para representar o valor <b>0</b> (neutro): Deixe as contas distantes da barra central.',
                'tutorial-li8': 'Uma característica especial do seu ábaco é que você pode representar o <b>0</b> de duas maneiras:',
                'tutorial-li9': '<strong class=\"text-teal-300\">Forma "vazia":</strong> Nenhuma conta toca a barra central.',
                'tutorial-li10': '<strong class=\"text-teal-300\">Forma "balanceada":</strong> Ambas as contas (a superior e a inferior) tocam a barra, já que a soma de \\(1 + (-1)\\) resulta em \\(0\\).',
                'tutorial-h3-2': 'Lendo o Valor Total',
                'tutorial-p4': 'O valor total do ábaco é a soma dos valores de cada haste. A aplicação calcula e exibe automaticamente o valor na base 10 (decimal). A notação matemática, como \\(1 \\cdot 3^1 + (-1) \\cdot 3^0\\), também é mostrada para ajudar a visualizar o cálculo.',

                'footer-sum-title': 'Como somar no ábaco',
                'footer-sum-p1': 'Para somar dois números, você pode usar o ábaco como uma calculadora manual: primeiro represente o primeiro número; depois aplique o segundo número haste a haste.',
                'footer-sum-li1': '<strong class="text-teal-300">1) Configure o primeiro número:</strong> Clique nas contas para formar o valor desejado. O total em decimal aparece acima.',
                'footer-sum-li2': '<strong class="text-teal-300">2) Adicione o segundo número:</strong> Comece pela haste da direita (\\(3^0\\)). Para cada unidade a somar, ative a conta de cima (\\(+1\\)); para cada unidade a subtrair, ative a de baixo (\\(-1\\)).',
                'footer-sum-li3': '<strong class="text-teal-300">3) Ajuste os "vai-um" balanceados:</strong> Se uma haste ficar com duas contas ativas do mesmo lado (equivalente a \\(+2\\) ou \\(-2\\)), troque por um dígito balanceado e carregue para a próxima haste: \\(+2 = -1 + 1\\cdot 3\\) e \\(-2 = 1 - 1\\cdot 3\\).',
                'footer-sum-note': 'Dica: quando ambas as contas tocam a barra na mesma haste, o valor local é \\(0\\) — isso ajuda a enxergar combinações como \\(1 + (-1) = 0\\). Você pode conferir o resultado na leitura em decimal e na notação matemática.',

                                'footer-sum-table-title': 'Tabela de combinações para somar',
                                'footer-sum-col1': 'Alvo (+n)',
                                'footer-sum-col2': 'Combinação em potências de 3',

                'footer-sub-title': 'Como subtrair no ábaco',
                'footer-sub-p1': 'Para subtrair \\(B\\) de \\(A\\), você pode pensar como soma com o oposto: some \\(-B\\). Outra forma é aplicar as unidades a subtrair haste a haste.',
                'footer-sub-li1': '<strong class="text-teal-300">1) Configure o minuendo \\(A\\):</strong> Represente \\(A\\) no ábaco. O total em decimal aparece acima.',
                'footer-sub-li2': '<strong class="text-teal-300">2) Subtraia o subtraendo \\(B\\):</strong> Comece pela haste da direita (\\(3^0\\)). Para cada unidade a subtrair, ative a conta de baixo (\\(-1\\)); para desfazer uma unidade, ative a de cima (\\(+1\\)).',
                'footer-sub-li3': '<strong class="text-teal-300">3) Ajuste os "empresta" balanceados:</strong> Se uma haste chegar a \\(-2\\) ou \\(+2\\), converta usando os dígitos balanceados e faça o empréstimo/transporte: \\(-2 = 1 - 1\\cdot 3\\) (empresta \\(1\\) para a próxima haste) e \\(+2 = -1 + 1\\cdot 3\\) (carrega \\(1\\) para a próxima haste).',
                'footer-sub-note': 'Dica: subtrair é o mesmo que somar o negativo. Para formar \\(-B\\), inverta os sinais dos dígitos de \\(B\\) (\\(1 \\leftrightarrow -1\\)) e então some.',

                'footer-sub-table-title': 'Tabela de combinações para subtrair',
                'footer-sub-col1': 'Alvo (-n)',
                'footer-sub-col2': 'Combinação em potências de 3',

                /* Soroban-inspired tips */
                'soroban-toggle': '💡 Dicas do Heisanban',
                'soroban-title': 'Dicas inspiradas no Soroban (ábaco japonês)',
                'soroban-p1': 'O Soroban traz práticas úteis de ergonomia e leitura que também servem para este ábaco ternário balanceado.',
                'soroban-li1': '<strong class="text-teal-300">Agrupamento visual:</strong> As hastes são separadas em grupos de 3 para facilitar a leitura de potências de 3.',
                'soroban-li2': '<strong class="text-teal-300">Céu e Terra:</strong> A área superior e a inferior têm um leve contraste, lembrando as regiões do Soroban e ajudando na referência visual.',
                'soroban-li3': '<strong class="text-teal-300">Botão de limpeza:</strong> Use o botão “Limpar” para zerar rapidamente o ábaco, como um movimento de varredura no Soroban.',
                'soroban-li4': '<strong class="text-teal-300">Leitura da direita para a esquerda:</strong> Comece sempre pela haste de \\(3^0\\) (direita) ao somar/subtrair, tal como se procede no Soroban.',
                'soroban-li5': '<strong class="text-teal-300">Fluxo de transporte/empresta:</strong> Ao atingir \\(+2\\) ou \\(-2\\) numa haste, converta para um dígito balanceado e transporte/empreste para a próxima haste.',
                'clear-button': 'Limpar'
                },
            'en': {
                'main-title': 'Balanced Ternary Abacus',
                'description': 'Click the beads to add (+1) or subtract (-1) and see the mathematical representation.',
                'total-title': 'Total Value',
                'tutorial-toggle': '👉 How to use the abacus tutorial',
                'sum-toggle': '➕ How to add',
                                'sub-toggle': '➖ How to subtract',
                'tutorial-title': 'Balanced Ternary Abacus Tutorial',
                'tutorial-p1': 'This quick guide explains how to use the interactive balanced ternary abacus, which uses the values <b>1</b> (positive), <b>0</b> (neutral), and <b>-1</b> (negative) to represent numbers.',
                'tutorial-p2': 'The abacus consists of several rods, where each one represents a power of 3. The rods are organized from right to left, starting with \\(3^0\\).',
                'tutorial-li1': '<strong class=\"text-teal-300\">First rod (on the right):</strong> \\(3^0\\) (value 1)',
                'tutorial-li2': '<strong class=\"text-teal-300\">Second rod:</strong> \\(3^1\\) (value 3)',
                'tutorial-li3': '<strong class=\"text-teal-300\">Third rod:</strong> \\(3^2\\) (value 9)',
                'tutorial-li4': 'and so on...',
                'tutorial-h3-1': 'Representing Values with the Beads',
                'tutorial-p3': 'Each rod has two beads: one on the top part and one on the bottom part. The central horizontal bar is the reference.',
                'tutorial-li5': 'To represent the value <b>1</b> (positive): Click the top bead so that it touches the central bar.',
                'tutorial-li6': 'To represent the value <b>-1</b> (negative): Click the bottom bead so that it touches the central bar.',
                'tutorial-li7': 'To represent the value <b>0</b> (neutral): Leave the beads away from the central bar.',
                'tutorial-li8': 'A special feature of your abacus is that you can represent <b>0</b> in two ways:',
                'tutorial-li9': '<strong class=\"text-teal-300\">"Empty" form:</strong> No beads touch the central bar.',
                'tutorial-li10': '<strong class=\"text-teal-300\">"Balanced" form:</strong> Both beads (the top and bottom) touch the bar, since the sum of \\(1 + (-1)\\) results in \\(0\\).',
                'tutorial-h3-2': 'Reading the Total Value',
                'tutorial-p4': 'The total value of the abacus is the sum of the values of each rod. The application automatically calculates and displays the value in base 10 (decimal). The mathematical notation, such as \\(1 \\cdot 3^1 + (-1) \\cdot 3^0\\), also is shown to help visualize the calculation.',

                'footer-sum-title': 'How to add using the abacus',
                'footer-sum-p1': 'To add two numbers, use the abacus like a manual calculator: first represent the first number; then apply the second number rod by rod.',
                'footer-sum-li1': '<strong class="text-teal-300">1) Set the first number:</strong> Click the beads to form the desired value. The decimal total is shown above.',
                'footer-sum-li2': '<strong class="text-teal-300">2) Add the second number:</strong> Start on the rightmost rod (\\(3^0\\)). For each unit to add, activate the top bead (\\(+1\\)); for each unit to subtract, activate the bottom bead (\\(-1\\)).',
                'footer-sum-li3': '<strong class="text-teal-300">3) Handle balanced carries:</strong> If a rod ends up with two active beads on the same side (equivalent to \\(+2\\) or \\(-2\\)), convert to a balanced digit and carry to the next rod: \\(+2 = -1 + 1\\cdot 3\\) and \\(-2 = 1 - 1\\cdot 3\\).',
                'footer-sum-note': 'Tip: when both beads touch the bar on the same rod, the local value is \\(0\\) — this helps to see combinations like \\(1 + (-1) = 0\\). You can verify the result in the decimal reading and in the mathematical notation.',

                                                                'footer-sum-table-title': 'Addition combinations table',
                                                                'footer-sum-col1': 'Target (+n)',
                                                                'footer-sum-col2': 'Combination in powers of 3',

                                'footer-sub-title': 'How to subtract using the abacus',
                                'footer-sub-p1': 'To subtract \\(B\\) from \\(A\\), think of it as addition with the opposite: add \\(-B\\). You can also apply the units to subtract rod by rod.',
                                'footer-sub-li1': '<strong class="text-teal-300">1) Set the minuend \\(A\\):</strong> Represent \\(A\\) on the abacus. The decimal total is shown above.',
                                'footer-sub-li2': '<strong class="text-teal-300">2) Subtract the subtrahend \\(B\\):</strong> Start on the rightmost rod (\\(3^0\\)). For each unit to subtract, activate the bottom bead (\\(-1\\)); to undo one unit, activate the top bead (\\(+1\\)).',
                                'footer-sub-li3': '<strong class="text-teal-300">3) Handle balanced borrows:</strong> If a rod reaches \\(-2\\) or \\(+2\\), convert using balanced digits and perform the borrow/carry: \\(-2 = 1 - 1\\cdot 3\\) (borrow \\(1\\) from the next rod) and \\(+2 = -1 + 1\\cdot 3\\) (carry \\(1\\) to the next rod).',
                                'footer-sub-note': 'Tip: subtraction is the same as adding the negative. To form \\(-B\\), flip the signs of the digits of \\(B\\) (\\(1 \\leftrightarrow -1\\)) and then add.',

                                'footer-sub-table-title': 'Subtraction combinations table',
                                'footer-sub-col1': 'Target (-n)',
                                'footer-sub-col2': 'Combination in powers of 3',

                                                /* Soroban-inspired tips */
                                                'soroban-toggle': '💡 Heisanban tips',
                                                'soroban-title': 'Tips inspired by the Soroban (Japanese abacus)',
                                                'soroban-p1': 'Soroban offers ergonomic and reading practices that are also useful for this balanced ternary abacus.',
                                                'soroban-li1': '<strong class="text-teal-300">Visual grouping:</strong> Rods are separated into groups of 3 to ease reading of powers of 3.',
                                                'soroban-li2': '<strong class="text-teal-300">Heaven and Earth:</strong> The top and bottom areas have a subtle contrast, recalling Soroban regions and helping visual reference.',
                                                'soroban-li3': '<strong class="text-teal-300">Clear button:</strong> Use the “Clear” button to quickly reset the abacus, similar to a sweeping motion on the Soroban.',
                                                'soroban-li4': '<strong class="text-teal-300">Read right-to-left:</strong> Always start with the \\(3^0\\) rod (right) when adding/subtracting, as done on the Soroban.',
                                                'soroban-li5': '<strong class="text-teal-300">Carry/borrow flow:</strong> When a rod reaches \\(+2\\) or \\(-2\\), convert to a balanced digit and carry/borrow to the next rod.',
                                                'clear-button': 'Clear'
                                            }
        };

        let currentLang = 'pt';

        const updateLanguage = () => {
            const lang = translations[currentLang];
            document.title = lang['main-title'];
            document.getElementById('main-title').textContent = lang['main-title'];
            document.getElementById('description').textContent = lang['description'];
            document.getElementById('total-title').textContent = lang['total-title'];
            document.getElementById('tutorial-toggle').textContent = lang['tutorial-toggle'];
            document.getElementById('sum-toggle').textContent = lang['sum-toggle'];
            document.getElementById('sub-toggle').textContent = lang['sub-toggle'];
            document.getElementById('soroban-toggle').textContent = lang['soroban-toggle'];
            document.getElementById('tutorial-title').textContent = lang['tutorial-title'];
            document.getElementById('tutorial-p1').innerHTML = lang['tutorial-p1'];
            document.getElementById('tutorial-p2').innerHTML = lang['tutorial-p2'];
            document.getElementById('tutorial-li1').innerHTML = lang['tutorial-li1'];
            document.getElementById('tutorial-li2').innerHTML = lang['tutorial-li2'];
            document.getElementById('tutorial-li3').innerHTML = lang['tutorial-li3'];
            document.getElementById('tutorial-li4').textContent = lang['tutorial-li4'];
            document.getElementById('tutorial-h3-1').textContent = lang['tutorial-h3-1'];
            document.getElementById('tutorial-p3').innerHTML = lang['tutorial-p3'];
            document.getElementById('tutorial-li5').innerHTML = lang['tutorial-li5'];
            document.getElementById('tutorial-li6').innerHTML = lang['tutorial-li6'];
            document.getElementById('tutorial-li7').innerHTML = lang['tutorial-li7'];
            document.getElementById('tutorial-li8').innerHTML = lang['tutorial-li8'];
            document.getElementById('tutorial-li9').innerHTML = lang['tutorial-li9'];
            document.getElementById('tutorial-li10').innerHTML = lang['tutorial-li10'];
            document.getElementById('tutorial-h3-2').textContent = lang['tutorial-h3-2'];
            document.getElementById('tutorial-p4').innerHTML = lang['tutorial-p4'];

            // Footer: How to add section
            document.getElementById('footer-sum-title').textContent = lang['footer-sum-title'];
            document.getElementById('footer-sum-p1').innerHTML = lang['footer-sum-p1'];
            document.getElementById('footer-sum-li1').innerHTML = lang['footer-sum-li1'];
            document.getElementById('footer-sum-li2').innerHTML = lang['footer-sum-li2'];
            document.getElementById('footer-sum-li3').innerHTML = lang['footer-sum-li3'];
            document.getElementById('footer-sum-note').innerHTML = lang['footer-sum-note'];

            // Sum combinations table headers
            document.getElementById('footer-sum-table-title').textContent = lang['footer-sum-table-title'];
            document.getElementById('footer-sum-col1').textContent = lang['footer-sum-col1'];
            document.getElementById('footer-sum-col2').textContent = lang['footer-sum-col2'];

            // Footer: How to subtract section
            document.getElementById('footer-sub-title').textContent = lang['footer-sub-title'];
            document.getElementById('footer-sub-p1').innerHTML = lang['footer-sub-p1'];
            document.getElementById('footer-sub-li1').innerHTML = lang['footer-sub-li1'];
            document.getElementById('footer-sub-li2').innerHTML = lang['footer-sub-li2'];
            document.getElementById('footer-sub-li3').innerHTML = lang['footer-sub-li3'];
            document.getElementById('footer-sub-note').innerHTML = lang['footer-sub-note'];
            // Subtraction combinations table headers
            document.getElementById('footer-sub-table-title').textContent = lang['footer-sub-table-title'];
            document.getElementById('footer-sub-col1').textContent = lang['footer-sub-col1'];
            document.getElementById('footer-sub-col2').textContent = lang['footer-sub-col2'];

            // Soroban tips section
            document.getElementById('soroban-title').textContent = lang['soroban-title'];
            document.getElementById('soroban-p1').innerHTML = lang['soroban-p1'];
            document.getElementById('soroban-li1').innerHTML = lang['soroban-li1'];
            document.getElementById('soroban-li2').innerHTML = lang['soroban-li2'];
            document.getElementById('soroban-li3').innerHTML = lang['soroban-li3'];
            document.getElementById('soroban-li4').innerHTML = lang['soroban-li4'];
            document.getElementById('soroban-li5').innerHTML = lang['soroban-li5'];

            // Clear button label
            document.getElementById('clear-button').textContent = lang['clear-button'];

            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        };

        translationBtn.addEventListener('click', () => {
            currentLang = currentLang === 'pt' ? 'en' : 'pt';
            translationBtn.textContent = currentLang.toUpperCase();
            updateLanguage();
        });

        // Wire foldable sections with a small helper (behavior unchanged)
        wireToggle(tutorialToggleBtn, tutorialContentDiv);
        wireToggle(sumToggleBtn, sumContentDiv);
        wireToggle(subToggleBtn, subContentDiv);
        wireToggle(sorobanToggleBtn, sorobanContentDiv);

        clearButton.addEventListener('click', () => {
            rodValues.fill(0);
            createAbacus();
        });

        const updateDisplay = () => {
            let total = 0;
            const terms = [];
            for (let i = 0; i < numRods; i++) {
                const value = rodValues[i];
                total += value * POW3[i];
                if (value !== 0) {
                    terms.unshift(`${value} \\cdot 3^{${i}}`);
                }
            }

            totalValueDisplay.textContent = total;
            mathNotationDisplay.textContent = terms.length
                ? `\\( ${terms.join(' + ')} \\)`
                : '';

            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        };

        const createAbacus = () => {
            abacusRodsContainer.innerHTML = '';
            for (let i = 0; i < numRods; i++) {
                const rod = document.createElement('div');
                rod.classList.add('rod');
                rod.setAttribute('data-index', i);

                const rodLine = document.createElement('div');
                rodLine.classList.add('rod-line');
                rod.appendChild(rodLine);

                const topBead = document.createElement('div');
                topBead.classList.add('bead', 'top');
                topBead.style.borderTopColor = COLOR_DEFAULT;
                topBead.addEventListener('click', () => {
                    topBead.classList.toggle('active');
                    applyRodState(i, topBead, bottomBead);
                    updateDisplay();
                });

                const bottomBead = document.createElement('div');
                bottomBead.classList.add('bead', 'bottom');
                bottomBead.style.borderBottomColor = COLOR_DEFAULT;
                bottomBead.addEventListener('click', () => {
                    bottomBead.classList.toggle('active');
                    applyRodState(i, topBead, bottomBead);
                    updateDisplay();
                });

                const topLabel = document.createElement('div');
                topLabel.classList.add('power-label-top');
                topLabel.textContent = String(Math.pow(3, i));

                const powerLabel = document.createElement('div');
                powerLabel.classList.add('power-label');
                powerLabel.textContent = `\\(3^{${i}}\\)`;

                rod.appendChild(topBead);
                rod.appendChild(bottomBead);
                rod.appendChild(topLabel);
                rod.appendChild(powerLabel);
                abacusRodsContainer.prepend(rod);
            }
            updateDisplay();
        };

        createAbacus();
    });
</script>
<script>
// Register Service Worker for offline support
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function () {
    navigator.serviceWorker.register('service-worker.js')
      .catch(function (err) { console.warn('SW registration failed', err); });
  });
}
</script>
</body>
</html>
